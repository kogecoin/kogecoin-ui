"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = loadPlugin;

var _lodash = _interopRequireDefault(require("lodash"));

var _path = _interopRequireDefault(require("path"));

var _constants = require("./constants");

var _logger = require("./logger");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

/**
 * Requires a module.
 * @param {*} path the module's path
 * @return {Object}
 */
function tryLoad(path) {
  try {
    return require(path);
  } catch (err) {
    if (err.code === _constants.MODULE_NOT_FOUND) {
      return null;
    }

    throw err;
  }
}

function mergeConfig(appConfig, pluginConfig) {
  return _lodash.default.merge(appConfig, pluginConfig);
}

function isValid(plugin) {
  return _lodash.default.isFunction(plugin) || _lodash.default.isFunction(plugin.default);
}

function isES6(plugin) {
  return Object.keys(plugin).includes('default');
} // export type PluginGeneric<R, T extends IPlugin<R> = ;

/**
 * Load a plugin following the rules
 * - First try to load from the internal directory plugins (which will disappear soon or later).
 * - A second attempt from the external plugin directory
 * - A third attempt from node_modules, in case to have multiple match as for instance verdaccio-ldap
 * and sinopia-ldap. All verdaccio prefix will have preferences.
 * @param {*} config a reference of the configuration settings
 * @param {*} pluginConfigs
 * @param {*} params a set of params to initialize the plugin
 * @param {*} sanityCheck callback that check the shape that should fulfill the plugin
 * @return {Array} list of plugins
 */


function loadPlugin(config, pluginConfigs = {}, params, sanityCheck, prefix = 'verdaccio') {
  return Object.keys(pluginConfigs).map(pluginId => {
    let plugin;

    const localPlugin = _path.default.resolve(__dirname + '/../plugins', pluginId); // try local plugins first


    plugin = tryLoad(localPlugin); // try the external plugin directory

    if (plugin === null && config.plugins) {
      const pluginDir = config.plugins;

      const externalFilePlugin = _path.default.resolve(pluginDir, pluginId);

      plugin = tryLoad(externalFilePlugin); // npm package

      if (plugin === null && pluginId.match(/^[^\.\/]/)) {
        plugin = tryLoad(_path.default.resolve(pluginDir, `${prefix}-${pluginId}`)); // compatibility for old sinopia plugins

        if (!plugin) {
          plugin = tryLoad(_path.default.resolve(pluginDir, `sinopia-${pluginId}`));
        }
      }
    } // npm package


    if (plugin === null && pluginId.match(/^[^\.\/]/)) {
      plugin = tryLoad(`${prefix}-${pluginId}`); // compatibility for old sinopia plugins

      if (!plugin) {
        plugin = tryLoad(`sinopia-${pluginId}`);
      }
    }

    if (plugin === null) {
      plugin = tryLoad(pluginId);
    } // relative to config path


    if (plugin === null && pluginId.match(/^\.\.?($|\/)/)) {
      plugin = tryLoad(_path.default.resolve(_path.default.dirname(config.self_path), pluginId));
    }

    if (plugin === null) {
      _logger.logger.error({
        content: pluginId,
        prefix
      }, 'plugin not found. try npm install @{prefix}-@{content}');

      throw Error(`
        ${prefix}-${pluginId} plugin not found. try "npm install ${prefix}-${pluginId}"`);
    }

    if (!isValid(plugin)) {
      _logger.logger.error({
        content: pluginId
      }, '@{prefix}-@{content} plugin does not have the right code structure');

      throw Error(`"${pluginId}" plugin does not have the right code structure`);
    }
    /* eslint new-cap:off */


    try {
      plugin = isES6(plugin) ? new plugin.default(mergeConfig(config, pluginConfigs[pluginId]), params) : plugin(pluginConfigs[pluginId], params);
    } catch (error) {
      plugin = null;

      _logger.logger.error({
        error,
        pluginId
      }, 'error loading a plugin @{pluginId}: @{error}');
    }
    /* eslint new-cap:off */


    if (plugin === null || !sanityCheck(plugin)) {
      _logger.logger.error({
        content: pluginId,
        prefix
      }, "@{prefix}-@{content} doesn't look like a valid plugin");

      throw Error(`sanity check has failed, "${pluginId}" is not a valid plugin`);
    }

    _logger.logger.warn({
      content: pluginId,
      prefix
    }, 'Plugin successfully loaded: @{prefix}-@{content}');

    return plugin;
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvcGx1Z2luLWxvYWRlci50cyJdLCJuYW1lcyI6WyJ0cnlMb2FkIiwicGF0aCIsInJlcXVpcmUiLCJlcnIiLCJjb2RlIiwiTU9EVUxFX05PVF9GT1VORCIsIm1lcmdlQ29uZmlnIiwiYXBwQ29uZmlnIiwicGx1Z2luQ29uZmlnIiwiXyIsIm1lcmdlIiwiaXNWYWxpZCIsInBsdWdpbiIsImlzRnVuY3Rpb24iLCJkZWZhdWx0IiwiaXNFUzYiLCJPYmplY3QiLCJrZXlzIiwiaW5jbHVkZXMiLCJsb2FkUGx1Z2luIiwiY29uZmlnIiwicGx1Z2luQ29uZmlncyIsInBhcmFtcyIsInNhbml0eUNoZWNrIiwicHJlZml4IiwibWFwIiwicGx1Z2luSWQiLCJsb2NhbFBsdWdpbiIsIlBhdGgiLCJyZXNvbHZlIiwiX19kaXJuYW1lIiwicGx1Z2lucyIsInBsdWdpbkRpciIsImV4dGVybmFsRmlsZVBsdWdpbiIsIm1hdGNoIiwiZGlybmFtZSIsInNlbGZfcGF0aCIsImxvZ2dlciIsImVycm9yIiwiY29udGVudCIsIkVycm9yIiwid2FybiJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUlBOztBQUNBOzs7O0FBRUE7QUFDQTtBQUNBO0FBQ0E7QUFDQTtBQUNBLFNBQVNBLE9BQVQsQ0FBaUJDLElBQWpCLEVBQW9DO0FBQ2xDLE1BQUk7QUFDRixXQUFPQyxPQUFPLENBQUNELElBQUQsQ0FBZDtBQUNELEdBRkQsQ0FFRSxPQUFPRSxHQUFQLEVBQVk7QUFDWixRQUFJQSxHQUFHLENBQUNDLElBQUosS0FBYUMsMkJBQWpCLEVBQW1DO0FBQ2pDLGFBQU8sSUFBUDtBQUNEOztBQUNELFVBQU1GLEdBQU47QUFDRDtBQUNGOztBQUVELFNBQVNHLFdBQVQsQ0FBcUJDLFNBQXJCLEVBQWdDQyxZQUFoQyxFQUFzRDtBQUNwRCxTQUFPQyxnQkFBRUMsS0FBRixDQUFRSCxTQUFSLEVBQW1CQyxZQUFuQixDQUFQO0FBQ0Q7O0FBRUQsU0FBU0csT0FBVCxD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T0ksSUFBUCxDQUFZO0FBQUVGLE1BQUFBLE9BQU8sRUFBRWIsUUFBWDtBQUFxQkYsTUFBQUE7QUFBckIsS0FBWixFQUEyQyxrREFBM0M7O0FBQ0EsV0FBT1osTUFBUDtBQUNELEdBcEVNLENBQVA7QUFxRUQiLCJzb3VyY2VzQ29udGVudCI6WyJpbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IFBhdGggZnJvbSAncGF0aCc7XG5cbmltcG9ydCB7IENvbmZpZywgSVBsdWdpbiB9IGZyb20gJ0B2ZXJkYWNjaW8vdHlwZXMnO1xuXG5pbXBvcnQgeyBNT0RVTEVfTk9UX0ZPVU5EIH0gZnJvbSAnLi9jb25zdGFudHMnO1xuaW1wb3J0IHsgbG9nZ2VyIH0gZnJvbSAnLi9sb2dnZXInO1xuXG4vKipcbiAqIFJlcXVpcmVzIGEgbW9kdWxlLlxuICogQHBhcmFtIHsqfSBwYXRoIHRoZSBtb2R1bGUncyBwYXRoXG4gKiBAcmV0dXJuIHtPYmplY3R9XG4gKi9cbmZ1bmN0aW9uIHRyeUxvYWQocGF0aDogc3RyaW5nKTogYW55IHtcbiAgdHJ5IHtcbiAgICByZXR1cm4gcmVxdWlyZShwYXRoKTtcbiAgfSBjYXRjaCAoZXJyKSB7XG4gICAgaWYgKGVyci5jb2RlID09PSBNT0RVTEVfTk9UX0ZPVU5EKSB7XG4gICAgICByZXR1cm4gbnVsbDtcbiAgICB9XG4gICAgdGhyb3cgZXJyO1xuICB9XG59XG5cbmZ1bmN0aW9uIG1lcmdlQ29uZmlnKGFwcENvbmZpZywgcGx1Z2luQ29uZmlnKTogQ29uZmlnIHtcbiAgcmV0dXJuIF8ubWVyZ2UoYXBwQ29uZmlnLCBwbHVnaW5Db25maWcpO1xufVxuXG5mdW5jdGlvbiBpc1ZhbGlkKHBsdWdpbik6IGJvb2xlYW4ge1xuICByZXR1cm4gXy5pc0Z1bmN0aW9uKHBsdWdpbikgfHwgXy5pc0Z1bmN0aW9uKHBsdWdpbi5kZWZhdWx0KTtcbn1cblxuZnVuY3Rpb24gaXNFUzYocGx1Z2luKTogYm9vbGVhbiB7XG4gIHJldHVybiBPYmplY3Qua2V5cyhwbHVnaW4pLmluY2x1ZGVzKCdkZWZhdWx0Jyk7XG59XG5cbi8vIGV4cG9ydCB0eXBlIFBsdWdpbkdlbmVyaWM8UiwgVCBleHRlbmRzIElQbHVnaW48Uj4gPSA7XG5cbi8qKlxuICogTG9hZCBhIHBsdWdpbiBmb2xsb3dpbmcgdGhlIHJ1bGVzXG4gKiAtIEZpcnN0IHRyeSB0byBsb2FkIGZyb20gdGhlIGludGVybmFsIGRpcmVjdG9yeSBwbHVnaW5zICh3aGljaCB3aWxsIGRpc2FwcGVhciBzb29uIG9yIGxhdGVyKS5cbiAqIC0gQSBzZWNvbmQgYXR0ZW1wdCBmcm9tIHRoZSBleHRlcm5hbCBwbHVnaW4gZGlyZWN0b3J5XG4gKiAtIEEgdGhpcmQgYXR0ZW1wdCBmcm9tIG5vZGVfbW9kdWxlcywgaW4gY2FzZSB0byBoYXZlIG11bHRpcGxlIG1hdGNoIGFzIGZvciBpbnN0YW5jZSB2ZXJkYWNjaW8tbGRhcFxuICogYW5kIHNpbm9waWEtbGRhcC4gQWxsIHZlcmRhY2NpbyBwcmVmaXggd2lsbCBoYXZlIHByZWZlcmVuY2VzLlxuICogQHBhcmFtIHsqfSBjb25maWcgYSByZWZlcmVuY2Ugb2YgdGhlIGNvbmZpZ3VyYXRpb24gc2V0dGluZ3NcbiAqIEBwYXJhbSB7Kn0gcGx1Z2luQ29uZmlnc1xuICogQHBhcmFtIHsqfSBwYXJhbXMgYSBzZXQgb2YgcGFyYW1zIHRvIGluaXRpYWxpemUgdGhlIHBsdWdpblxuICogQHBhcmFtIHsqfSBzYW5pdHlDaGVjayBjYWxsYmFjayB0aGF0IGNoZWNrIHRoZSBzaGFwZSB0aGF0IHNob3VsZCBmdWxmaWxsIHRoZSBwbHVnaW5cbiAqIEByZXR1cm4ge0FycmF5fSBsaXN0IG9mIHBsdWdpbnNcbiAqL1xuZXhwb3J0IGRlZmF1bHQgZnVuY3Rpb24gbG9hZFBsdWdpbjxUIGV4dGVuZHMgSVBsdWdpbjxUPj4oY29uZmlnOiBDb25maWcsIHBsdWdpbkNvbmZpZ3M6IGFueSA9IHt9LCBwYXJhbXM6IGFueSwgc2FuaXR5Q2hlY2s6IGFueSwgcHJlZml4OiBzdHJpbmcgPSAndmVyZGFjY2lvJyk6IGFueVtdIHtcbiAgcmV0dXJuIE9iamVjdC5rZXlzKHBsdWdpbkNvbmZpZ3MpLm1hcCgocGx1Z2luSWQ6IHN0cmluZyk6IElQbHVnaW48VD4gPT4ge1xuICAgIGxldCBwbHVnaW47XG5cbiAgICBjb25zdCBsb2NhbFBsdWdpbiA9IFBhdGgucmVzb2x2ZShfX2Rpcm5hbWUgKyAnLy4uL3BsdWdpbnMnLCBwbHVnaW5JZCk7XG4gICAgLy8gdHJ5IGxvY2FsIHBsdWdpbnMgZmlyc3RcbiAgICBwbHVnaW4gPSB0cnlMb2FkKGxvY2FsUGx1Z2luKTtcblxuICAgIC8vIHRyeSB0aGUgZXh0ZXJuYWwgcGx1Z2luIGRpcmVjdG9yeVxuICAgIGlmIChwbHVnaW4gPT09IG51bGwgJiYgY29uZmlnLnBsdWdpbnMpIHtcbiAgICAgIGNvbnN0IHBsdWdpbkRpciA9IGNvbmZpZy5wbHVnaW5zO1xuICAgICAgY29uc3QgZXh0ZXJuYWxGaWxlUGx1Z2luID0gUGF0aC5yZXNvbHZlKHBsdWdpbkRpciwgcGx1Z2luSWQpO1xuICAgICAgcGx1Z2luID0gdHJ5TG9hZChleHRlcm5hbEZpbGVQbHVnaW4pO1xuXG4gICAgICAvLyBucG0gcGFja2FnZVxuICAgICAgaWYgKHBsdWdpbiA9PT0gbnVsbCAmJiBwbHVnaW5JZC5tYXRjaCgvXlteXFwuXFwvXS8pKSB7XG4gICAgICAgIHBsdWdpbiA9IHRyeUxvYWQoUGF0aC5yZXNvbHZlKHBsdWdpbkRpciwgYCR7cHJlZml4fS0ke3BsdWdpbklkfWApKTtcbiAgICAgICAgLy8gY29tcGF0aWJpbGl0eSBmb3Igb2xkIHNpbm9waWEgcGx1Z2luc1xuICAgICAgICBpZiAoIXBsdWdpbikge1xuICAgICAgICAgIHBsdWdpbiA9IHRyeUxvYWQoUGF0aC5yZXNvbHZlKHBsdWdpbkRpciwgYHNpbm9waWEtJHtwbHVnaW5JZH1gKSk7XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICB9XG5cbiAgICAvLyBucG0gcGFja2FnZVxuICAgIGlmIChwbHVnaW4gPT09IG51bGwgJiYgcGx1Z2luSWQubWF0Y2goL15bXlxcLlxcL10vKSkge1xuICAgICAgcGx1Z2luID0gdHJ5TG9hZChgJHtwcmVmaXh9LSR7cGx1Z2luSWR9YCk7XG4gICAgICAvLyBjb21wYXRpYmlsaXR5IGZvciBvbGQgc2lub3BpYSBwbHVnaW5zXG4gICAgICBpZiAoIXBsdWdpbikge1xuICAgICAgICBwbHVnaW4gPSB0cnlMb2FkKGBzaW5vcGlhLSR7cGx1Z2luSWR9YCk7XG4gICAgICB9XG4gICAgfVxuXG4gICAgaWYgKHBsdWdpbiA9PT0gbnVsbCkge1xuICAgICAgcGx1Z2luID0gdHJ5TG9hZChwbHVnaW5JZCk7XG4gICAgfVxuXG4gICAgLy8gcmVsYXRpdmUgdG8gY29uZmlnIHBhdGhcbiAgICBpZiAocGx1Z2luID09PSBudWxsICYmIHBsdWdpbklkLm1hdGNoKC9eXFwuXFwuPygkfFxcLykvKSkge1xuICAgICAgcGx1Z2luID0gdHJ5TG9hZChQYXRoLnJlc29sdmUoUGF0aC5kaXJuYW1lKGNvbmZpZy5zZWxmX3BhdGgpLCBwbHVnaW5JZCkpO1xuICAgIH1cblxuICAgIGlmIChwbHVnaW4gPT09IG51bGwpIHtcbiAgICAgIGxvZ2dlci5lcnJvcih7IGNvbnRlbnQ6IHBsdWdpbklkLCBwcmVmaXggfSwgJ3BsdWdpbiBub3QgZm91bmQuIHRyeSBucG0gaW5zdGFsbCBAe3ByZWZpeH0tQHtjb250ZW50fScpO1xuICAgICAgdGhyb3cgRXJyb3IoYFxuICAgICAgICAke3ByZWZpeH0tJHtwbHVnaW5JZH0gcGx1Z2luIG5vdCBmb3VuZC4gdHJ5IFwibnBtIGluc3RhbGwgJHtwcmVmaXh9LSR7cGx1Z2luSWR9XCJgKTtcbiAgICB9XG5cbiAgICBpZiAoIWlzVmFsaWQocGx1Z2luKSkge1xuICAgICAgbG9nZ2VyLmVycm9yKHsgY29udGVudDogcGx1Z2luSWQgfSwgJ0B7cHJlZml4fS1Ae2NvbnRlbnR9IHBsdWdpbiBkb2VzIG5vdCBoYXZlIHRoZSByaWdodCBjb2RlIHN0cnVjdHVyZScpO1xuICAgICAgdGhyb3cgRXJyb3IoYFwiJHtwbHVnaW5JZH1cIiBwbHVnaW4gZG9lcyBub3QgaGF2ZSB0aGUgcmlnaHQgY29kZSBzdHJ1Y3R1cmVgKTtcbiAgICB9XG5cbiAgICAvKiBlc2xpbnQgbmV3LWNhcDpvZmYgKi9cbiAgICB0cnkge1xuICAgICAgcGx1Z2luID0gaXNFUzYocGx1Z2luKSA/IG5ldyBwbHVnaW4uZGVmYXVsdChtZXJnZUNvbmZpZyhjb25maWcsIHBsdWdpbkNvbmZpZ3NbcGx1Z2luSWRdKSwgcGFyYW1zKSA6IHBsdWdpbihwbHVnaW5Db25maWdzW3BsdWdpbklkXSwgcGFyYW1zKTtcbiAgICB9IGNhdGNoIChlcnJvcikge1xuICAgICAgcGx1Z2luID0gbnVsbDtcbiAgICAgIGxvZ2dlci5lcnJvcih7IGVycm9yLCBwbHVnaW5JZCB9LCAnZXJyb3IgbG9hZGluZyBhIHBsdWdpbiBAe3BsdWdpbklkfTogQHtlcnJvcn0nKTtcbiAgICB9XG4gICAgLyogZXNsaW50IG5ldy1jYXA6b2ZmICovXG5cbiAgICBpZiAocGx1Z2luID09PSBudWxsIHx8ICFzYW5pdHlDaGVjayhwbHVnaW4pKSB7XG4gICAgICBsb2dnZXIuZXJyb3IoeyBjb250ZW50OiBwbHVnaW5JZCwgcHJlZml4IH0sIFwiQHtwcmVmaXh9LUB7Y29udGVudH0gZG9lc24ndCBsb29rIGxpa2UgYSB2YWxpZCBwbHVnaW5cIik7XG4gICAgICB0aHJvdyBFcnJvcihgc2FuaXR5IGNoZWNrIGhhcyBmYWlsZWQsIFwiJHtwbHVnaW5JZH1cIiBpcyBub3QgYSB2YWxpZCBwbHVnaW5gKTtcbiAgICB9XG5cbiAgICBsb2dnZXIud2Fybih7IGNvbnRlbnQ6IHBsdWdpbklkLCBwcmVmaXggfSwgJ1BsdWdpbiBzdWNjZXNzZnVsbHkgbG9hZGVkOiBAe3ByZWZpeH0tQHtjb250ZW50fScpO1xuICAgIHJldHVybiBwbHVnaW47XG4gIH0pO1xufVxuIl19