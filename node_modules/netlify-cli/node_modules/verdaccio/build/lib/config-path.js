"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = void 0;

var _fs = _interopRequireDefault(require("fs"));

var _lodash = _interopRequireDefault(require("lodash"));

var _mkdirp = _interopRequireDefault(require("mkdirp"));

var _path = _interopRequireDefault(require("path"));

var _logger = require("./logger");

var _utils = require("./utils");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const CONFIG_FILE = 'config.yaml';
const XDG = 'xdg';
const WIN = 'win';
const WIN32 = 'win32'; // eslint-disable-next-line

const pkgJSON = require('../../package.json');

/**
 * Find and get the first config file that match.
 * @return {String} the config file path
 */
function findConfigFile(configPath) {
  if (_lodash.default.isNil(configPath) === false) {
    return _path.default.resolve(configPath);
  }

  const configPaths = getConfigPaths();

  if (_lodash.default.isEmpty(configPaths)) {
    throw new Error('no configuration files can be processed');
  }

  const primaryConf = _lodash.default.find(configPaths, configLocation => (0, _utils.fileExists)(configLocation.path));

  if (_lodash.default.isNil(primaryConf) === false) {
    return primaryConf.path;
  }

  return createConfigFile(_lodash.default.head(configPaths)).path;
}

function createConfigFile(configLocation) {
  createConfigFolder(configLocation);
  const defaultConfig = updateStorageLinks(configLocation, readDefaultConfig());

  _fs.default.writeFileSync(configLocation.path, defaultConfig);

  return configLocation;
}

function readDefaultConfig() {
  return _fs.default.readFileSync(require.resolve('../../conf/default.yaml'), 'utf-8');
}

function createConfigFolder(configLocation) {
  _mkdirp.default.sync(_path.default.dirname(configLocation.path));

  _logger.logger.info({
    file: configLocation.path
  }, 'Creating default config file in @{file}');
}

function updateStorageLinks(configLocation, defaultConfig) {
  if (configLocation.type !== XDG) {
    return defaultConfig;
  } // $XDG_DATA_HOME defines the base directory relative to which user specific data files should be stored,
  // If $XDG_DATA_HOME is either not set or empty, a default equal to $HOME/.local/share should be used.
  // $FlowFixMe


  let dataDir = process.env.XDG_DATA_HOME || _path.default.join(process.env.HOME, '.local', 'share');

  if ((0, _utils.folderExists)(dataDir)) {
    dataDir = _path.default.resolve(_path.default.join(dataDir, pkgJSON.name, 'storage'));
    return defaultConfig.replace(/^storage: .\/storage$/m, `storage: ${dataDir}`);
  }

  return defaultConfig;
}

function getConfigPaths() {
  const listPaths = [getXDGDirectory(), getWindowsDirectory(), getRelativeDefaultDirectory(), getOldDirectory()].reduce(function (acc, currentValue) {
    if (_lodash.default.isUndefined(currentValue) === false) {
      acc.push(currentValue);
    }

    return acc;
  }, []);
  return listPaths;
}

const getXDGDirectory = () => {
  const XDGConfig = getXDGHome() || process.env.HOME && _path.default.join(process.env.HOME, '.config');

  if (XDGConfig && (0, _utils.folderExists)(XDGConfig)) {
    return {
      path: _path.default.join(XDGConfig, pkgJSON.name, CONFIG_FILE),
      type: XDG
    };
  }
};

const getXDGHome = () => process.env.XDG_CONFIG_HOME;

const getWindowsDirectory = () => {
  if (process.platform === WIN32 && process.env.APPDATA && (0, _utils.folderExists)(process.env.APPDATA)) {
    return {
      path: _path.default.resolve(_path.default.join(process.env.APPDATA, pkgJSON.name, CONFIG_FILE)),
      type: WIN
    };
  }
};

const getRelativeDefaultDirectory = () => {
  return {
    path: _path.default.resolve(_path.default.join('.', pkgJSON.name, CONFIG_FILE)),
    type: 'def'
  };
};

const getOldDirectory = () => {
  return {
    path: _path.default.resolve(_path.default.join('.', CONFIG_FILE)),
    type: 'old'
  };
};

var _default = findConfigFile;
exports.default = _default;
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uL3NyYy9saWIvY29uZmlnLXBhdGgudHMiXSwibmFtZXMiOlsiQ09ORklHX0ZJTEUiLCJYREciLCJXSU4iLCJXSU4zMiIsInBrZ0pTT04iLCJyZXF1aXJlIiwiZmluZENvbmZpZ0ZpbGUiLCJjb25maWdQYXRoIiwiXyIsImlzTmlsIiwiUGF0aCIsInJlc29sdmUiLCJjb25maWdQYXRocyIsImdldENvbmZpZ1BhdGhzIiwiaXNFbXB0eSIsIkVycm9yIiwicHJpbWFyeUNvbmYiLCJmaW5kIiwiY29uZmlnTG9jYXRpb24iLCJwYXRoIiwiY3JlYXRlQ29uZmlnRmlsZSIsImhlYWQiLCJjcmVhdGVDb25maWdGb2xkZXIiLCJkZWZhdWx0Q29uZmlnIiwidXBkYXRlU3RvcmFnZUxpbmtzIiwicmVhZERlZmF1bHRDb25maWciLCJmcyIsIndyaXRlRmlsZVN5bmMiLCJyZWFkRmlsZVN5bmMiLCJta2RpcnAiLCJzeW5jIiwiZGlybmFtZSIsImxvZ2dlciIsImluZm8iLCJmaWxlIiwidHlwZSIsImRhdGFEaXIiLCJwcm9jZXNzIiwiZW52IiwiWERHX0RBVEFfSE9NRSIsImpvaW4iLCJIT01FIiwibmFtZSIsInJlcGxhY2UiLCJsaXN0UGF0aHMiLCJnZXRYREdEaXJlY3RvcnkiLCJnZXRXaW5kb3dzRGlyZWN0b3J5IiwiZ2V0UmVsYXRpdmVEZWZhdWx0RGlyZWN0b3J5IiwiZ2V0T2xkRGlyZWN0b3J5IiwicmVkdWNlIiwiYWNjIiwiY3VycmVudFZhbHVlIiwiaXNVbmRlZmluZWQiLCJwdXNoIiwiWERHQ29uZmlnIiwiZ2V0WERHSG9tZSIsIlhER19DT05GSUdfSE9NRSIsInBsYXRmb3JtIiwiQVBQREFUQSJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUFBOztBQUNBOztBQUNBOztBQUNBOztBQUdBOztBQUNBOzs7O0FBRUEsTUFBTUEsV0FBVyxHQUFHLGFBQXBCO0FBQ0EsTUFBTUMsR0FBRyxHQUFHLEtBQVo7QUFDQSxNQUFNQyxHQUFHLEdBQUcsS0FBWjtBQUNBLE1B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LElBQXZDLEVBQTZDMUMsV0FBN0MsQ0FBYixDQUREO0FBRUxtQyxNQUFBQSxJQUFJLEVBQUVqQztBQUZELEtBQVA7QUFJRDtBQUNGLENBUEQ7O0FBU0EsTUFBTTZDLDJCQUEyQixHQUFHLE1BQXNCO0FBQ3hELFNBQU87QUFDTDVCLElBQUFBLElBQUksRUFBRVQsY0FBS0MsT0FBTCxDQUFhRCxjQUFLOEIsSUFBTCxDQUFVLEdBQVYsRUFBZXBDLE9BQU8sQ0FBQ3NDLElBQXZCLEVBQTZCMUMsV0FBN0IsQ0FBYixDQUREO0FBRUxtQyxJQUFBQSxJQUFJLEVBQUU7QUFGRCxHQUFQO0FBSUQsQ0FMRDs7QUFPQSxNQUFNYSxlQUFlLEdBQUcsTUFBc0I7QUFDNUMsU0FBTztBQUNMN0IsSUFBQUEsSUFBSSxFQUFFVCxjQUFLQyxPQUFMLENBQWFELGNBQUs4QixJQUFMLENBQVUsR0FBVixFQUFleEMsV0FBZixDQUFiLENBREQ7QUFFTG1DLElBQUFBLElBQUksRUFBRTtBQUZELEdBQVA7QUFJRCxDQUxEOztlQU9lN0IsYyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCBmcyBmcm9tICdmcyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuaW1wb3J0IG1rZGlycCBmcm9tICdta2RpcnAnO1xuaW1wb3J0IFBhdGggZnJvbSAncGF0aCc7XG5cbmltcG9ydCB7IENIQVJBQ1RFUl9FTkNPRElORyB9IGZyb20gJy4vY29uc3RhbnRzJztcbmltcG9ydCB7IGxvZ2dlciB9IGZyb20gJy4vbG9nZ2VyJztcbmltcG9ydCB7IGZpbGVFeGlzdHMsIGZvbGRlckV4aXN0cyB9IGZyb20gJy4vdXRpbHMnO1xuXG5jb25zdCBDT05GSUdfRklMRSA9ICdjb25maWcueWFtbCc7XG5jb25zdCBYREcgPSAneGRnJztcbmNvbnN0IFdJTiA9ICd3aW4nO1xuY29uc3QgV0lOMzIgPSAnd2luMzInO1xuLy8gZXNsaW50LWRpc2FibGUtbmV4dC1saW5lXG5jb25zdCBwa2dKU09OID0gcmVxdWlyZSgnLi4vLi4vcGFja2FnZS5qc29uJyk7XG5cbmV4cG9ydCB0eXBlIFNldHVwRGlyZWN0b3J5ID0ge1xuICBwYXRoOiBzdHJpbmc7XG4gIHR5cGU6IHN0cmluZztcbn07XG5cbi8qKlxuICogRmluZCBhbmQgZ2V0IHRoZSBmaXJzdCBjb25maWcgZmlsZSB0aGF0IG1hdGNoLlxuICogQHJldHVybiB7U3RyaW5nfSB0aGUgY29uZmlnIGZpbGUgcGF0aFxuICovXG5mdW5jdGlvbiBmaW5kQ29uZmlnRmlsZShjb25maWdQYXRoOiBzdHJpbmcpOiBzdHJpbmcge1xuICBpZiAoXy5pc05pbChjb25maWdQYXRoKSA9PT0gZmFsc2UpIHtcbiAgICByZXR1cm4gUGF0aC5yZXNvbHZlKGNvbmZpZ1BhdGgpO1xuICB9XG5cbiAgY29uc3QgY29uZmlnUGF0aHM6IFNldHVwRGlyZWN0b3J5W10gPSBnZXRDb25maWdQYXRocygpO1xuXG4gIGlmIChfLmlzRW1wdHkoY29uZmlnUGF0aHMpKSB7XG4gICAgdGhyb3cgbmV3IEVycm9yKCdubyBjb25maWd1cmF0aW9uIGZpbGVzIGNhbiBiZSBwcm9jZXNzZWQnKTtcbiAgfVxuXG4gIGNvbnN0IHByaW1hcnlDb25mOiBhbnkgPSBfLmZpbmQoY29uZmlnUGF0aHMsIChjb25maWdMb2NhdGlvbjogYW55KSA9PiBmaWxlRXhpc3RzKGNvbmZpZ0xvY2F0aW9uLnBhdGgpKTtcbiAgaWYgKF8uaXNOaWwocHJpbWFyeUNvbmYpID09PSBmYWxzZSkge1xuICAgIHJldHVybiBwcmltYXJ5Q29uZi5wYXRoO1xuICB9XG5cbiAgcmV0dXJuIGNyZWF0ZUNvbmZpZ0ZpbGUoXy5oZWFkKGNvbmZpZ1BhdGhzKSkucGF0aDtcbn1cblxuZnVuY3Rpb24gY3JlYXRlQ29uZmlnRmlsZShjb25maWdMb2NhdGlvbjogYW55KTogU2V0dXBEaXJlY3Rvcnkge1xuICBjcmVhdGVDb25maWdGb2xkZXIoY29uZmlnTG9jYXRpb24pO1xuXG4gIGNvbnN0IGRlZmF1bHRDb25maWcgPSB1cGRhdGVTdG9yYWdlTGlua3MoY29uZmlnTG9jYXRpb24sIHJlYWREZWZhdWx0Q29uZmlnKCkpO1xuXG4gIGZzLndyaXRlRmlsZVN5bmMoY29uZmlnTG9jYXRpb24ucGF0aCwgZGVmYXVsdENvbmZpZyk7XG5cbiAgcmV0dXJuIGNvbmZpZ0xvY2F0aW9uO1xufVxuXG5mdW5jdGlvbiByZWFkRGVmYXVsdENvbmZpZygpOiBzdHJpbmcge1xuICByZXR1cm4gZnMucmVhZEZpbGVTeW5jKHJlcXVpcmUucmVzb2x2ZSgnLi4vLi4vY29uZi9kZWZhdWx0LnlhbWwnKSwgJ3V0Zi04Jyk7XG59XG5cbmZ1bmN0aW9uIGNyZWF0ZUNvbmZpZ0ZvbGRlcihjb25maWdMb2NhdGlvbik6IHZvaWQge1xuICBta2RpcnAuc3luYyhQYXRoLmRpcm5hbWUoY29uZmlnTG9jYXRpb24ucGF0aCkpO1xuICBsb2dnZXIuaW5mbyh7IGZpbGU6IGNvbmZpZ0xvY2F0aW9uLnBhdGggfSwgJ0NyZWF0aW5nIGRlZmF1bHQgY29uZmlnIGZpbGUgaW4gQHtmaWxlfScpO1xufVxuXG5mdW5jdGlvbiB1cGRhdGVTdG9yYWdlTGlua3MoY29uZmlnTG9jYXRpb24sIGRlZmF1bHRDb25maWcpOiBzdHJpbmcge1xuICBpZiAoY29uZmlnTG9jYXRpb24udHlwZSAhPT0gWERHKSB7XG4gICAgcmV0dXJuIGRlZmF1bHRDb25maWc7XG4gIH1cblxuICAvLyAkWERHX0RBVEFfSE9NRSBkZWZpbmVzIHRoZSBiYXNlIGRpcmVjdG9yeSByZWxhdGl2ZSB0byB3aGljaCB1c2VyIHNwZWNpZmljIGRhdGEgZmlsZXMgc2hvdWxkIGJlIHN0b3JlZCxcbiAgLy8gSWYgJFhER19EQVRBX0hPTUUgaXMgZWl0aGVyIG5vdCBzZXQgb3IgZW1wdHksIGEgZGVmYXVsdCBlcXVhbCB0byAkSE9NRS8ubG9jYWwvc2hhcmUgc2hvdWxkIGJlIHVzZWQuXG4gIC8vICRGbG93Rml4TWVcbiAgbGV0IGRhdGFEaXIgPSBwcm9jZXNzLmVudi5YREdfREFUQV9IT01FIHx8IFBhdGguam9pbihwcm9jZXNzLmVudi5IT01FIGFzIHN0cmluZywgJy5sb2NhbCcsICdzaGFyZScpO1xuICBpZiAoZm9sZGVyRXhpc3RzKGRhdGFEaXIpKSB7XG4gICAgZGF0YURpciA9IFBhdGgucmVzb2x2ZShQYXRoLmpvaW4oZGF0YURpciwgcGtnSlNPTi5uYW1lLCAnc3RvcmFnZScpKTtcbiAgICByZXR1cm4gZGVmYXVsdENvbmZpZy5yZXBsYWNlKC9ec3RvcmFnZTogLlxcL3N0b3JhZ2UkL20sIGBzdG9yYWdlOiAke2RhdGFEaXJ9YCk7XG4gIH1cbiAgcmV0dXJuIGRlZmF1bHRDb25maWc7XG59XG5cbmZ1bmN0aW9uIGdldENvbmZpZ1BhdGhzKCk6IFNldHVwRGlyZWN0b3J5W10ge1xuICBjb25zdCBsaXN0UGF0aHM6IFNldHVwRGlyZWN0b3J5W10gPSBbZ2V0WERHRGlyZWN0b3J5KCksIGdldFdpbmRvd3NEaXJlY3RvcnkoKSwgZ2V0UmVsYXRpdmVEZWZhdWx0RGlyZWN0b3J5KCksIGdldE9sZERpcmVjdG9yeSgpXS5yZWR1Y2UoZnVuY3Rpb24gKFxuICAgIGFjYyxcbiAgICBjdXJyZW50VmFsdWU6IGFueVxuICApOiBTZXR1cERpcmVjdG9yeVtdIHtcbiAgICBpZiAoXy5pc1VuZGVmaW5lZChjdXJyZW50VmFsdWUpID09PSBmYWxzZSkge1xuICAgICAgYWNjLnB1c2goY3VycmVudFZhbHVlKTtcbiAgICB9XG4gICAgcmV0dXJuIGFjYztcbiAgfSxcbiAgW10gYXMgU2V0dXBEaXJlY3RvcnlbXSk7XG5cbiAgcmV0dXJuIGxpc3RQYXRocztcbn1cblxuY29uc3QgZ2V0WERHRGlyZWN0b3J5ID0gKCk6IFNldHVwRGlyZWN0b3J5IHwgdm9pZCA9PiB7XG4gIGNvbnN0IFhER0NvbmZpZyA9IGdldFhER0hvbWUoKSB8fCAocHJvY2Vzcy5lbnYuSE9NRSAmJiBQYXRoLmpvaW4ocHJvY2Vzcy5lbnYuSE9NRSwgJy5jb25maWcnKSk7XG5cbiAgaWYgKFhER0NvbmZpZyAmJiBmb2xkZXJFeGlzdHMoWERHQ29uZmlnKSkge1xuICAgIHJldHVybiB7XG4gICAgICBwYXRoOiBQYXRoLmpvaW4oWERHQ29uZmlnLCBwa2dKU09OLm5hbWUsIENPTkZJR19GSUxFKSxcbiAgICAgIHR5cGU6IFhERyxcbiAgICB9O1xuICB9XG59O1xuXG5jb25zdCBnZXRYREdIb21lID0gKCk6IHN0cmluZyB8IHZvaWQgPT4gcHJvY2Vzcy5lbnYuWERHX0NPTkZJR19IT01FO1xuXG5jb25zdCBnZXRXaW5kb3dzRGlyZWN0b3J5ID0gKCk6IFNldHVwRGlyZWN0b3J5IHwgdm9pZCA9PiB7XG4gIGlmIChwcm9jZXNzLnBsYXRmb3JtID09PSBXSU4zMiAmJiBwcm9jZXNzLmVudi5BUFBEQVRBICYmIGZvbGRlckV4aXN0cyhwcm9jZXNzLmVudi5BUFBEQVRBKSkge1xuICAgIHJldHVybiB7XG4gICAgICBwYXRoOiBQYXRoLnJlc29sdmUoUGF0aC5qb2luKHByb2Nlc3MuZW52LkFQUERBVEEsIHBrZ0pTT04ubmFtZSwgQ09ORklHX0ZJTEUpKSxcbiAgICAgIHR5cGU6IFdJTixcbiAgICB9O1xuICB9XG59O1xuXG5jb25zdCBnZXRSZWxhdGl2ZURlZmF1bHREaXJlY3RvcnkgPSAoKTogU2V0dXBEaXJlY3RvcnkgPT4ge1xuICByZXR1cm4ge1xuICAgIHBhdGg6IFBhdGgucmVzb2x2ZShQYXRoLmpvaW4oJy4nLCBwa2dKU09OLm5hbWUsIENPTkZJR19GSUxFKSksXG4gICAgdHlwZTogJ2RlZicsXG4gIH07XG59O1xuXG5jb25zdCBnZXRPbGREaXJlY3RvcnkgPSAoKTogU2V0dXBEaXJlY3RvcnkgPT4ge1xuICByZXR1cm4ge1xuICAgIHBhdGg6IFBhdGgucmVzb2x2ZShQYXRoLmpvaW4oJy4nLCBDT05GSUdfRklMRSkpLFxuICAgIHR5cGU6ICdvbGQnLFxuICB9O1xufTtcblxuZXhwb3J0IGRlZmF1bHQgZmluZENvbmZpZ0ZpbGU7XG4iXX0=