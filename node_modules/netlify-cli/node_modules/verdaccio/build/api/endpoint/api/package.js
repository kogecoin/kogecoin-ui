"use strict";

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.default = _default;

var _lodash = _interopRequireDefault(require("lodash"));

var _constants = require("../../../lib/constants");

var _utils = require("../../../lib/utils");

var _middleware = require("../../middleware");

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

const downloadStream = (packageName, filename, storage, req, res) => {
  const stream = storage.getTarball(packageName, filename);
  stream.on('content-length', function (content) {
    res.header('Content-Length', content);
  });
  stream.on('error', function (err) {
    return res.locals.report_error(err);
  });
  res.header(_constants.HEADERS.CONTENT_TYPE, _constants.HEADERS.OCTET_STREAM);
  stream.pipe(res);
};

const redirectOrDownloadStream = (packageName, filename, storage, req, res, config) => {
  const tarballUrlRedirect = _lodash.default.get(config, 'experiments.tarball_url_redirect');

  storage.hasLocalTarball(packageName, filename).then(hasLocalTarball => {
    if (hasLocalTarball) {
      const context = {
        packageName,
        filename
      };
      const tarballUrl = typeof tarballUrlRedirect === 'function' ? tarballUrlRedirect(context) : _lodash.default.template(tarballUrlRedirect)(context);
      res.redirect(tarballUrl);
    } else {
      downloadStream(packageName, filename, storage, req, res);
    }
  }).catch(err => {
    res.locals.report_error(err);
  });
};

function _default(route, auth, storage, config) {
  const can = (0, _middleware.allow)(auth); // TODO: anonymous user?

  route.get('/:package/:version?', can('access'), function (req, res, next) {
    const getPackageMetaCallback = function (err, metadata) {
      if (err) {
        return next(err);
      }

      metadata = (0, _utils.convertDistRemoteToLocalTarballUrls)(metadata, req, config.url_prefix);
      let queryVersion = req.params.version;

      if (_lodash.default.isNil(queryVersion)) {
        return next(metadata);
      }

      let version = (0, _utils.getVersion)(metadata, queryVersion);

      if (_lodash.default.isNil(version) === false) {
        return next(version);
      }

      if (_lodash.default.isNil(metadata[_constants.DIST_TAGS]) === false) {
        if (_lodash.default.isNil(metadata[_constants.DIST_TAGS][queryVersion]) === false) {
          queryVersion = metadata[_constants.DIST_TAGS][queryVersion];
          version = (0, _utils.getVersion)(metadata, queryVersion);

          if (_lodash.default.isNil(version) === false) {
            return next(version);
          }
        }
      }

      return next(_utils.ErrorCode.getNotFound(`${_constants.API_ERROR.VERSION_NOT_EXIST}: ${req.params.version}`));
    };

    storage.getPackage({
      name: req.params.package,
      uplinksLook: true,
      req,
      callback: getPackageMetaCallback
    });
  });
  route.get('/:scopedPackage/-/:scope/:filename', can('access'), function (req, res) {
    const {
      scopedPackage,
      filename
    } = req.params;

    if (_lodash.default.get(config, 'experiments.tarball_url_redirect') === undefined) {
      downloadStream(scopedPackage, filename, storage, req, res);
    } else {
      redirectOrDownloadStream(scopedPackage, filename, storage, req, res, config);
    }
  });
  route.get('/:package/-/:filename', can('access'), function (req, res) {
    if (_lodash.default.get(config, 'experiments.tarball_url_redirect') === undefined) {
      downloadStream(req.params.package, req.params.filename, storage, req, res);
    } else {
      redirectOrDownloadStream(req.params.package, req.params.filename, storage, req, res, config);
    }
  });
}
//# sourceMappingURL=data:application/json;charset=utf-8;base64,eyJ2ZXJzaW9uIjozLCJzb3VyY2VzIjpbIi4uLy4uLy4uLy4uL3NyYy9hcGkvZW5kcG9pbnQvYXBpL3BhY2thZ2UudHMiXSwibmFtZXMiOlsiZG93bmxvYWRTdHJlYW0iLCJwYWNrYWdlTmFtZSIsImZpbGVuYW1lIiwic3RvcmFnZSIsInJlcSIsInJlcyIsInN0cmVhbSIsImdldFRhcmJhbGwiLCJvbiIsImNvbnRlbnQiLCJoZWFkZXIiLCJlcnIiLCJsb2NhbHMiLCJyZXBvcnRfZXJyb3IiLCJIRUFERVJTIiwiQ09OVEVOVF9UWVBFIiwiT0NURVRfU1RSRUFNIiwicGlwZSIsInJlZGlyZWN0T3JEb3dubG9hZFN0cmVhbSIsImNvbmZpZyIsInRhcmJhbGxVcmxSZWRpcmVjdCIsIl8iLCJnZXQiLCJoYXNMb2NhbFRhcmJhbGwiLCJ0aGVuIiwiY29udGV4dCIsInRhcmJhbGxVcmwiLCJ0ZW1wbGF0ZSIsInJlZGlyZWN0IiwiY2F0Y2giLCJyb3V0ZSIsImF1dGgiLCJjYW4iLCJuZXh0IiwiZ2V0UGFja2FnZU1ldGFDYWxsYmFjayIsIm1ldGFkYXRhIiwidXJsX3ByZWZpeCIsInF1ZXJ5VmVyc2lvbiIsInBhcmFtcyIsInZlcnNpb24iLCJpc05pbCIsIkRJU1RfVEFHUyIsIkVycm9yQ29kZSIsImdldE5vdEZvdW5kIiwiQVBJX0VSUk9SIiwiVkVSU0lPTl9OT1RfRVhJU1QiLCJnZXRQYWNrYWdlIiwibmFtZSIsInBhY2thZ2UiLCJ1cGxpbmtzTG9vayIsImNhbGxiYWNrIiwic2NvcGVkUGFja2FnZSIsInVuZGVmaW5lZCJdLCJtYXBwaW5ncyI6Ijs7Ozs7OztBQUNBOztBQUtBOztBQUNBOztBQUNBOzs7O0FBRUEsTUFBTUEsY0FBYyxHQUFHLENBQUNDLFdBQUQsRUFBc0JDLFFBQXRCLEVBQXdDQyxPQUF4QyxFQUFzREMsR0FBdEQsRUFBMkVDLEdBQTNFLEtBQTBHO0FBQy9ILFFBQU1DLE1BQU0sR0FBR0gsT0FBTyxDQUFDSSxVQUFSLENBQW1CTixXQUFuQixFQUFnQ0MsUUFBaEMsQ0FBZjtBQUVBSSxFQUFB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QUYsQ0FBTUgsTUFBTixFQUFjLGtDQUFkLE1BQXNEaUMsU0FBMUQsRUFBcUU7QUFDbkVwRCxNQUFBQSxjQUFjLENBQUNtRCxhQUFELEVBQWdCakQsUUFBaEIsRUFBMEJDLE9BQTFCLEVBQW1DQyxHQUFuQyxFQUF3Q0MsR0FBeEMsQ0FBZDtBQUNELEtBRkQsTUFFTztBQUNMYSxNQUFBQSx3QkFBd0IsQ0FBQ2lDLGFBQUQsRUFBZ0JqRCxRQUFoQixFQUEwQkMsT0FBMUIsRUFBbUNDLEdBQW5DLEVBQXdDQyxHQUF4QyxFQUE2Q2MsTUFBN0MsQ0FBeEI7QUFDRDtBQUNGLEdBUEQ7QUFTQVcsRUFBQUEsS0FBSyxDQUFDUixHQUFOLENBQVUsdUJBQVYsRUFBbUNVLEdBQUcsQ0FBQyxRQUFELENBQXRDLEVBQWtELFVBQVU1QixHQUFWLEVBQStCQyxHQUEvQixFQUEyRDtBQUMzRyxRQUFJZ0IsZ0JBQUVDLEdBQUYsQ0FBTUgsTUFBTixFQUFjLGtDQUFkLE1BQXNEaUMsU0FBMUQsRUFBcUU7QUFDbkVwRCxNQUFBQSxjQUFjLENBQUNJLEdBQUcsQ0FBQ2tDLE1BQUosQ0FBV1UsT0FBWixFQUFxQjVDLEdBQUcsQ0FBQ2tDLE1BQUosQ0FBV3BDLFFBQWhDLEVBQTBDQyxPQUExQyxFQUFtREMsR0FBbkQsRUFBd0RDLEdBQXhELENBQWQ7QUFDRCxLQUZELE1BRU87QUFDTGEsTUFBQUEsd0JBQXdCLENBQUNkLEdBQUcsQ0FBQ2tDLE1BQUosQ0FBV1UsT0FBWixFQUFxQjVDLEdBQUcsQ0FBQ2tDLE1BQUosQ0FBV3BDLFFBQWhDLEVBQTBDQyxPQUExQyxFQUFtREMsR0FBbkQsRUFBd0RDLEdBQXhELEVBQTZEYyxNQUE3RCxDQUF4QjtBQUNEO0FBQ0YsR0FORDtBQU9EIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUm91dGVyIH0gZnJvbSAnZXhwcmVzcyc7XG5pbXBvcnQgXyBmcm9tICdsb2Rhc2gnO1xuXG5pbXBvcnQgeyBDb25maWcsIFBhY2thZ2UgfSBmcm9tICdAdmVyZGFjY2lvL3R5cGVzJztcblxuaW1wb3J0IHsgJE5leHRGdW5jdGlvblZlciwgJFJlcXVlc3RFeHRlbmQsICRSZXNwb25zZUV4dGVuZCwgSUF1dGgsIElTdG9yYWdlSGFuZGxlciB9IGZyb20gJy4uLy4uLy4uLy4uL3R5cGVzJztcbmltcG9ydCB7IEFQSV9FUlJPUiwgRElTVF9UQUdTLCBIRUFERVJTIH0gZnJvbSAnLi4vLi4vLi4vbGliL2NvbnN0YW50cyc7XG5pbXBvcnQgeyBFcnJvckNvZGUsIGNvbnZlcnREaXN0UmVtb3RlVG9Mb2NhbFRhcmJhbGxVcmxzLCBnZXRWZXJzaW9uIH0gZnJvbSAnLi4vLi4vLi4vbGliL3V0aWxzJztcbmltcG9ydCB7IGFsbG93IH0gZnJvbSAnLi4vLi4vbWlkZGxld2FyZSc7XG5cbmNvbnN0IGRvd25sb2FkU3RyZWFtID0gKHBhY2thZ2VOYW1lOiBzdHJpbmcsIGZpbGVuYW1lOiBzdHJpbmcsIHN0b3JhZ2U6IGFueSwgcmVxOiAkUmVxdWVzdEV4dGVuZCwgcmVzOiAkUmVzcG9uc2VFeHRlbmQpOiB2b2lkID0+IHtcbiAgY29uc3Qgc3RyZWFtID0gc3RvcmFnZS5nZXRUYXJiYWxsKHBhY2thZ2VOYW1lLCBmaWxlbmFtZSk7XG5cbiAgc3RyZWFtLm9uKCdjb250ZW50LWxlbmd0aCcsIGZ1bmN0aW9uIChjb250ZW50KTogdm9pZCB7XG4gICAgcmVzLmhlYWRlcignQ29udGVudC1MZW5ndGgnLCBjb250ZW50KTtcbiAgfSk7XG5cbiAgc3RyZWFtLm9uKCdlcnJvcicsIGZ1bmN0aW9uIChlcnIpOiB2b2lkIHtcbiAgICByZXR1cm4gcmVzLmxvY2Fscy5yZXBvcnRfZXJyb3IoZXJyKTtcbiAgfSk7XG5cbiAgcmVzLmhlYWRlcihIRUFERVJTLkNPTlRFTlRfVFlQRSwgSEVBREVSUy5PQ1RFVF9TVFJFQU0pO1xuICBzdHJlYW0ucGlwZShyZXMpO1xufTtcblxuY29uc3QgcmVkaXJlY3RPckRvd25sb2FkU3RyZWFtID0gKHBhY2thZ2VOYW1lOiBzdHJpbmcsIGZpbGVuYW1lOiBzdHJpbmcsIHN0b3JhZ2U6IGFueSwgcmVxOiAkUmVxdWVzdEV4dGVuZCwgcmVzOiAkUmVzcG9uc2VFeHRlbmQsIGNvbmZpZzogQ29uZmlnKTogdm9pZCA9PiB7XG4gIGNvbnN0IHRhcmJhbGxVcmxSZWRpcmVjdCA9IF8uZ2V0KGNvbmZpZywgJ2V4cGVyaW1lbnRzLnRhcmJhbGxfdXJsX3JlZGlyZWN0Jyk7XG4gIHN0b3JhZ2VcbiAgICAuaGFzTG9jYWxUYXJiYWxsKHBhY2thZ2VOYW1lLCBmaWxlbmFtZSlcbiAgICAudGhlbigoaGFzTG9jYWxUYXJiYWxsKSA9PiB7XG4gICAgICBpZiAoaGFzTG9jYWxUYXJiYWxsKSB7XG4gICAgICAgIGNvbnN0IGNvbnRleHQgPSB7IHBhY2thZ2VOYW1lLCBmaWxlbmFtZSB9O1xuICAgICAgICBjb25zdCB0YXJiYWxsVXJsID0gdHlwZW9mIHRhcmJhbGxVcmxSZWRpcmVjdCA9PT0gJ2Z1bmN0aW9uJyA/IHRhcmJhbGxVcmxSZWRpcmVjdChjb250ZXh0KSA6IF8udGVtcGxhdGUodGFyYmFsbFVybFJlZGlyZWN0KShjb250ZXh0KTtcbiAgICAgICAgcmVzLnJlZGlyZWN0KHRhcmJhbGxVcmwpO1xuICAgICAgfSBlbHNlIHtcbiAgICAgICAgZG93bmxvYWRTdHJlYW0ocGFja2FnZU5hbWUsIGZpbGVuYW1lLCBzdG9yYWdlLCByZXEsIHJlcyk7XG4gICAgICB9XG4gICAgfSlcbiAgICAuY2F0Y2goKGVycikgPT4ge1xuICAgICAgcmVzLmxvY2Fscy5yZXBvcnRfZXJyb3IoZXJyKTtcbiAgICB9KTtcbn07XG5cbmV4cG9ydCBkZWZhdWx0IGZ1bmN0aW9uIChyb3V0ZTogUm91dGVyLCBhdXRoOiBJQXV0aCwgc3RvcmFnZTogSVN0b3JhZ2VIYW5kbGVyLCBjb25maWc6IENvbmZpZyk6IHZvaWQge1xuICBjb25zdCBjYW4gPSBhbGxvdyhhdXRoKTtcbiAgLy8gVE9ETzogYW5vbnltb3VzIHVzZXI/XG4gIHJvdXRlLmdldCgnLzpwYWNrYWdlLzp2ZXJzaW9uPycsIGNhbignYWNjZXNzJyksIGZ1bmN0aW9uIChyZXE6ICRSZXF1ZXN0RXh0ZW5kLCByZXM6ICRSZXNwb25zZUV4dGVuZCwgbmV4dDogJE5leHRGdW5jdGlvblZlcik6IHZvaWQge1xuICAgIGNvbnN0IGdldFBhY2thZ2VNZXRhQ2FsbGJhY2sgPSBmdW5jdGlvbiAoZXJyLCBtZXRhZGF0YTogUGFja2FnZSk6IHZvaWQge1xuICAgICAgaWYgKGVycikge1xuICAgICAgICByZXR1cm4gbmV4dChlcnIpO1xuICAgICAgfVxuICAgICAgbWV0YWRhdGEgPSBjb252ZXJ0RGlzdFJlbW90ZVRvTG9jYWxUYXJiYWxsVXJscyhtZXRhZGF0YSwgcmVxLCBjb25maWcudXJsX3ByZWZpeCk7XG5cbiAgICAgIGxldCBxdWVyeVZlcnNpb24gPSByZXEucGFyYW1zLnZlcnNpb247XG4gICAgICBpZiAoXy5pc05pbChxdWVyeVZlcnNpb24pKSB7XG4gICAgICAgIHJldHVybiBuZXh0KG1ldGFkYXRhKTtcbiAgICAgIH1cblxuICAgICAgbGV0IHZlcnNpb24gPSBnZXRWZXJzaW9uKG1ldGFkYXRhLCBxdWVyeVZlcnNpb24pO1xuICAgICAgaWYgKF8uaXNOaWwodmVyc2lvbikgPT09IGZhbHNlKSB7XG4gICAgICAgIHJldHVybiBuZXh0KHZlcnNpb24pO1xuICAgICAgfVxuXG4gICAgICBpZiAoXy5pc05pbChtZXRhZGF0YVtESVNUX1RBR1NdKSA9PT0gZmFsc2UpIHtcbiAgICAgICAgaWYgKF8uaXNOaWwobWV0YWRhdGFbRElTVF9UQUdTXVtxdWVyeVZlcnNpb25dKSA9PT0gZmFsc2UpIHtcbiAgICAgICAgICBxdWVyeVZlcnNpb24gPSBtZXRhZGF0YVtESVNUX1RBR1NdW3F1ZXJ5VmVyc2lvbl07XG4gICAgICAgICAgdmVyc2lvbiA9IGdldFZlcnNpb24obWV0YWRhdGEsIHF1ZXJ5VmVyc2lvbik7XG4gICAgICAgICAgaWYgKF8uaXNOaWwodmVyc2lvbikgPT09IGZhbHNlKSB7XG4gICAgICAgICAgICByZXR1cm4gbmV4dCh2ZXJzaW9uKTtcbiAgICAgICAgICB9XG4gICAgICAgIH1cbiAgICAgIH1cbiAgICAgIHJldHVybiBuZXh0KEVycm9yQ29kZS5nZXROb3RGb3VuZChgJHtBUElfRVJST1IuVkVSU0lPTl9OT1RfRVhJU1R9OiAke3JlcS5wYXJhbXMudmVyc2lvbn1gKSk7XG4gICAgfTtcblxuICAgIHN0b3JhZ2UuZ2V0UGFja2FnZSh7XG4gICAgICBuYW1lOiByZXEucGFyYW1zLnBhY2thZ2UsXG4gICAgICB1cGxpbmtzTG9vazogdHJ1ZSxcbiAgICAgIHJlcSxcbiAgICAgIGNhbGxiYWNrOiBnZXRQYWNrYWdlTWV0YUNhbGxiYWNrLFxuICAgIH0pO1xuICB9KTtcblxuICByb3V0ZS5nZXQoJy86c2NvcGVkUGFja2FnZS8tLzpzY29wZS86ZmlsZW5hbWUnLCBjYW4oJ2FjY2VzcycpLCBmdW5jdGlvbiAocmVxOiAkUmVxdWVzdEV4dGVuZCwgcmVzOiAkUmVzcG9uc2VFeHRlbmQpOiB2b2lkIHtcbiAgICBjb25zdCB7IHNjb3BlZFBhY2thZ2UsIGZpbGVuYW1lIH0gPSByZXEucGFyYW1zO1xuICAgIGlmIChfLmdldChjb25maWcsICdleHBlcmltZW50cy50YXJiYWxsX3VybF9yZWRpcmVjdCcpID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGRvd25sb2FkU3RyZWFtKHNjb3BlZFBhY2thZ2UsIGZpbGVuYW1lLCBzdG9yYWdlLCByZXEsIHJlcyk7XG4gICAgfSBlbHNlIHtcbiAgICAgIHJlZGlyZWN0T3JEb3dubG9hZFN0cmVhbShzY29wZWRQYWNrYWdlLCBmaWxlbmFtZSwgc3RvcmFnZSwgcmVxLCByZXMsIGNvbmZpZyk7XG4gICAgfVxuICB9KTtcblxuICByb3V0ZS5nZXQoJy86cGFja2FnZS8tLzpmaWxlbmFtZScsIGNhbignYWNjZXNzJyksIGZ1bmN0aW9uIChyZXE6ICRSZXF1ZXN0RXh0ZW5kLCByZXM6ICRSZXNwb25zZUV4dGVuZCk6IHZvaWQge1xuICAgIGlmIChfLmdldChjb25maWcsICdleHBlcmltZW50cy50YXJiYWxsX3VybF9yZWRpcmVjdCcpID09PSB1bmRlZmluZWQpIHtcbiAgICAgIGRvd25sb2FkU3RyZWFtKHJlcS5wYXJhbXMucGFja2FnZSwgcmVxLnBhcmFtcy5maWxlbmFtZSwgc3RvcmFnZSwgcmVxLCByZXMpO1xuICAgIH0gZWxzZSB7XG4gICAgICByZWRpcmVjdE9yRG93bmxvYWRTdHJlYW0ocmVxLnBhcmFtcy5wYWNrYWdlLCByZXEucGFyYW1zLmZpbGVuYW1lLCBzdG9yYWdlLCByZXEsIHJlcywgY29uZmlnKTtcbiAgICB9XG4gIH0pO1xufVxuIl19