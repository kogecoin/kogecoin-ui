{"version":3,"sources":["../src/utils.ts"],"names":["lockAndRead","name","cb","lock","err","res","parseHTPasswd","input","split","reduce","result","line","args","length","verifyPassword","passwd","hash","match","bcrypt","compareSync","indexOf","substr","crypto","createHash","update","digest","addUserToHTPasswd","body","user","encodeURIComponent","status","crypt3","comment","Date","toJSON","newline","sanityCheck","password","verifyFn","users","maxUsers","Error","auth","Object","keys","getCryptoPassword","changePasswordToHTPasswd","newPasswd","lines","map","username","_passwd","_newPasswd","replace","join"],"mappings":"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","sourcesContent":["import crypto from 'crypto';\n\nimport md5 from 'apache-md5';\nimport bcrypt from 'bcryptjs';\nimport createError, { HttpError } from 'http-errors';\nimport { readFile } from '@verdaccio/file-locking';\nimport { Callback } from '@verdaccio/types';\n\nimport crypt3 from './crypt3';\n\n// this function neither unlocks file nor closes it\n// it'll have to be done manually later\nexport function lockAndRead(name: string, cb: Callback): void {\n  readFile(name, { lock: true }, (err, res) => {\n    if (err) {\n      return cb(err);\n    }\n\n    return cb(null, res);\n  });\n}\n\n/**\n * parseHTPasswd - convert htpasswd lines to object.\n * @param {string} input\n * @returns {object}\n */\nexport function parseHTPasswd(input: string): Record<string, any> {\n  return input.split('\\n').reduce((result, line) => {\n    const args = line.split(':', 3);\n    if (args.length > 1) {\n      result[args[0]] = args[1];\n    }\n    return result;\n  }, {});\n}\n\n/**\n * verifyPassword - matches password and it's hash.\n * @param {string} passwd\n * @param {string} hash\n * @returns {boolean}\n */\nexport function verifyPassword(passwd: string, hash: string): boolean {\n  if (hash.match(/^\\$2(a|b|y)\\$/)) {\n    return bcrypt.compareSync(passwd, hash);\n  } else if (hash.indexOf('{PLAIN}') === 0) {\n    return passwd === hash.substr(7);\n  } else if (hash.indexOf('{SHA}') === 0) {\n    return (\n      crypto\n        .createHash('sha1')\n        // https://nodejs.org/api/crypto.html#crypto_hash_update_data_inputencoding\n        .update(passwd, 'utf8')\n        .digest('base64') === hash.substr(5)\n    );\n  }\n  // for backwards compatibility, first check md5 then check crypt3\n  return md5(passwd, hash) === hash || crypt3(passwd, hash) === hash;\n}\n\n/**\n * addUserToHTPasswd - Generate a htpasswd format for .htpasswd\n * @param {string} body\n * @param {string} user\n * @param {string} passwd\n * @returns {string}\n */\nexport function addUserToHTPasswd(body: string, user: string, passwd: string): string {\n  if (user !== encodeURIComponent(user)) {\n    const err = createError('username should not contain non-uri-safe characters');\n\n    err.status = 409;\n    throw err;\n  }\n\n  if (crypt3) {\n    passwd = crypt3(passwd);\n  } else {\n    passwd =\n      '{SHA}' +\n      crypto\n        .createHash('sha1')\n        .update(passwd, 'utf8')\n        .digest('base64');\n  }\n  const comment = 'autocreated ' + new Date().toJSON();\n  let newline = `${user}:${passwd}:${comment}\\n`;\n\n  if (body.length && body[body.length - 1] !== '\\n') {\n    newline = '\\n' + newline;\n  }\n  return body + newline;\n}\n\n/**\n * Sanity check for a user\n * @param {string} user\n * @param {object} users\n * @param {number} maxUsers\n * @returns {object}\n */\nexport function sanityCheck(\n  user: string,\n  password: string,\n  verifyFn: Callback,\n  users: {},\n  maxUsers: number\n): HttpError | null {\n  let err;\n\n  // check for user or password\n  if (!user || !password) {\n    err = Error('username and password is required');\n    err.status = 400;\n    return err;\n  }\n\n  const hash = users[user];\n\n  if (maxUsers < 0) {\n    err = Error('user registration disabled');\n    err.status = 409;\n    return err;\n  }\n\n  if (hash) {\n    const auth = verifyFn(password, users[user]);\n    if (auth) {\n      err = Error('username is already registered');\n      err.status = 409;\n      return err;\n    }\n    err = Error('unauthorized access');\n    err.status = 401;\n    return err;\n  } else if (Object.keys(users).length >= maxUsers) {\n    err = Error('maximum amount of users reached');\n    err.status = 403;\n    return err;\n  }\n\n  return null;\n}\n\nexport function getCryptoPassword(password: string): string {\n  return `{SHA}${crypto\n    .createHash('sha1')\n    .update(password, 'utf8')\n    .digest('base64')}`;\n}\n\n/**\n * changePasswordToHTPasswd - change password for existing user\n * @param {string} body\n * @param {string} user\n * @param {string} passwd\n * @param {string} newPasswd\n * @returns {string}\n */\nexport function changePasswordToHTPasswd(body: string, user: string, passwd: string, newPasswd: string): string {\n  let lines = body.split('\\n');\n  lines = lines.map(line => {\n    const [username, password] = line.split(':', 3);\n\n    if (username === user) {\n      let _passwd;\n      let _newPasswd;\n      if (crypt3) {\n        _passwd = crypt3(passwd, password);\n        _newPasswd = crypt3(newPasswd);\n      } else {\n        _passwd = getCryptoPassword(passwd);\n        _newPasswd = getCryptoPassword(newPasswd);\n      }\n\n      if (password == _passwd) {\n        // replace old password hash with new password hash\n        line = line.replace(_passwd, _newPasswd);\n      } else {\n        throw new Error('Invalid old Password');\n      }\n    }\n    return line;\n  });\n\n  return lines.join('\\n');\n}\n"],"file":"utils.js"}