{"version":3,"sources":["../src/htpasswd.ts"],"names":["HTPasswd","constructor","config","stuff","users","logger","verdaccioConfig","maxUsers","max_users","Infinity","lastTime","file","Error","path","Path","resolve","dirname","self_path","authenticate","user","password","cb","reload","err","code","adduser","realCb","pathPass","sanity","verifyPassword","res","locked","body","toString","_writeFile","callback","fs","stat","stats","mtime","readFile","buffer","Object","assign","_stringToUt8","authentication","writeFile","changePassword","newPassword","pathPassFile"],"mappings":"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","sourcesContent":["import fs from 'fs';\nimport Path from 'path';\n\nimport { Callback, AuthConf, Config, IPluginAuth } from '@verdaccio/types';\nimport { unlockFile } from '@verdaccio/file-locking';\n\nimport {\n  verifyPassword,\n  lockAndRead,\n  parseHTPasswd,\n  addUserToHTPasswd,\n  changePasswordToHTPasswd,\n  sanityCheck,\n} from './utils';\n\nexport interface VerdaccioConfigApp extends Config {\n  file: string;\n}\n\n/**\n * HTPasswd - Verdaccio auth class\n */\nexport default class HTPasswd implements IPluginAuth<VerdaccioConfigApp> {\n  /**\n   *\n   * @param {*} config htpasswd file\n   * @param {object} stuff config.yaml in object from\n   */\n  private users: {};\n  private stuff: {};\n  private config: {};\n  private verdaccioConfig: Config;\n  private maxUsers: number;\n  private path: string;\n  private logger: {};\n  private lastTime: any;\n  // constructor\n  public constructor(config: AuthConf, stuff: VerdaccioConfigApp) {\n    this.users = {};\n\n    // config for this module\n    this.config = config;\n    this.stuff = stuff;\n\n    // verdaccio logger\n    this.logger = stuff.logger;\n\n    // verdaccio main config object\n    this.verdaccioConfig = stuff.config;\n\n    // all this \"verdaccio_config\" stuff is for b/w compatibility only\n    this.maxUsers = config.max_users ? config.max_users : Infinity;\n\n    this.lastTime = null;\n\n    const { file } = config;\n\n    if (!file) {\n      throw new Error('should specify \"file\" in config');\n    }\n\n    this.path = Path.resolve(Path.dirname(this.verdaccioConfig.self_path), file);\n  }\n\n  /**\n   * authenticate - Authenticate user.\n   * @param {string} user\n   * @param {string} password\n   * @param {function} cd\n   * @returns {function}\n   */\n  public authenticate(user: string, password: string, cb: Callback): void {\n    this.reload(err => {\n      if (err) {\n        return cb(err.code === 'ENOENT' ? null : err);\n      }\n      if (!this.users[user]) {\n        return cb(null, false);\n      }\n      if (!verifyPassword(password, this.users[user])) {\n        return cb(null, false);\n      }\n\n      // authentication succeeded!\n      // return all usergroups this user has access to;\n      // (this particular package has no concept of usergroups, so just return\n      // user herself)\n      return cb(null, [user]);\n    });\n  }\n\n  /**\n   * Add user\n   * 1. lock file for writing (other processes can still read)\n   * 2. reload .htpasswd\n   * 3. write new data into .htpasswd.tmp\n   * 4. move .htpasswd.tmp to .htpasswd\n   * 5. reload .htpasswd\n   * 6. unlock file\n   *\n   * @param {string} user\n   * @param {string} password\n   * @param {function} realCb\n   * @returns {function}\n   */\n  public adduser(user: string, password: string, realCb: Callback): any {\n    const pathPass = this.path;\n    let sanity = sanityCheck(user, password, verifyPassword, this.users, this.maxUsers);\n\n    // preliminary checks, just to ensure that file won't be reloaded if it's\n    // not needed\n    if (sanity) {\n      return realCb(sanity, false);\n    }\n\n    lockAndRead(pathPass, (err, res): void => {\n      let locked = false;\n\n      // callback that cleans up lock first\n      const cb = (err): void => {\n        if (locked) {\n          unlockFile(pathPass, () => {\n            // ignore any error from the unlock\n            realCb(err, !err);\n          });\n        } else {\n          realCb(err, !err);\n        }\n      };\n\n      if (!err) {\n        locked = true;\n      }\n\n      // ignore ENOENT errors, we'll just create .htpasswd in that case\n      if (err && err.code !== 'ENOENT') {\n        return cb(err);\n      }\n      const body = (res || '').toString('utf8');\n      this.users = parseHTPasswd(body);\n\n      // real checks, to prevent race conditions\n      // parsing users after reading file.\n      sanity = sanityCheck(user, password, verifyPassword, this.users, this.maxUsers);\n\n      if (sanity) {\n        return cb(sanity);\n      }\n\n      try {\n        this._writeFile(addUserToHTPasswd(body, user, password), cb);\n      } catch (err) {\n        return cb(err);\n      }\n    });\n  }\n\n  /**\n   * Reload users\n   * @param {function} callback\n   */\n  public reload(callback: Callback): void {\n    fs.stat(this.path, (err, stats) => {\n      if (err) {\n        return callback(err);\n      }\n      if (this.lastTime === stats.mtime) {\n        return callback();\n      }\n\n      this.lastTime = stats.mtime;\n\n      fs.readFile(this.path, 'utf8', (err, buffer) => {\n        if (err) {\n          return callback(err);\n        }\n\n        Object.assign(this.users, parseHTPasswd(buffer));\n        callback();\n      });\n    });\n  }\n\n  private _stringToUt8(authentication: string): string {\n    return (authentication || '').toString();\n  }\n\n  private _writeFile(body: string, cb: Callback): void {\n    fs.writeFile(this.path, body, err => {\n      if (err) {\n        cb(err);\n      } else {\n        this.reload(() => {\n          cb(null);\n        });\n      }\n    });\n  }\n\n  /**\n   * changePassword - change password for existing user.\n   * @param {string} user\n   * @param {string} password\n   * @param {function} cd\n   * @returns {function}\n   */\n  public changePassword(user: string, password: string, newPassword: string, realCb: Callback): void {\n    lockAndRead(this.path, (err, res) => {\n      let locked = false;\n      const pathPassFile = this.path;\n\n      // callback that cleans up lock first\n      const cb = (err): void => {\n        if (locked) {\n          unlockFile(pathPassFile, () => {\n            // ignore any error from the unlock\n            realCb(err, !err);\n          });\n        } else {\n          realCb(err, !err);\n        }\n      };\n\n      if (!err) {\n        locked = true;\n      }\n\n      if (err && err.code !== 'ENOENT') {\n        return cb(err);\n      }\n\n      const body = this._stringToUt8(res);\n      this.users = parseHTPasswd(body);\n\n      if (!this.users[user]) {\n        return cb(new Error('User not found'));\n      }\n\n      try {\n        this._writeFile(changePasswordToHTPasswd(body, user, password, newPassword), cb);\n      } catch (err) {\n        return cb(err);\n      }\n    });\n  }\n}\n"],"file":"htpasswd.js"}